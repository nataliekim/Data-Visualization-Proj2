<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>D3 Clock</title>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<link href="d3clock.css" rel="stylesheet">
</head>
<body>
	<script>
	d3.queue()
	.defer(d3.csv, "CHpercentages.csv")
	.await(function (error, rawData) {
		var dataArray = d3.values(rawData).filter(function (d) {
			if (typeof d == "object") return d;
		});
		dataArray = dataArray.slice(0, dataArray.length - 1);
		var input = dataArray[0]['Sex Abuse '];
		console.log(input);

		var showD3Clock = function () {
			var w = 600; 
			var h = 600;

			var cx = w / 2;
			var cy = h / 2; 
			var margin = 10;
			var r = w / 2 - margin; 

			var rotate = 180;

			var svg = d3.select("body").append("svg")
			.attr("class", "clock")
			.attr("width", w)
			.attr("height", h);

			clockFace();
			minuteHand();
			hourHand();
			secondHand(input);
   

 //svg.append("circle").attr("cx",width/2).attr("cy",height/2).attr("r","5");

//rotation function called every second
    setInterval(function(){
    	if (rotate == 540) {
    		rotate = 210;
    	} else {
        	rotate+=30;
    	}
        checkInput();
             d3.select("#myRect").transition().duration("900").attr("transform","translate("+w/2+","+h/2+")rotate("+rotate+")");
             d3.select("#myRect2").transition().duration("900").attr("transform","translate("+w/2+","+h/2+")rotate("+rotate+")").attr("height", input * 150);
         },1000);


			function clockFace() {
				var hourTickLength = Math.round(r * 0.2);
				var minuteTickLength = Math.round(r * 0.1);
				for (var i = 0; i < 60; i++) {
					var tickLength, tickClass;
					if (i % 5 == 0) {
						tickLength = hourTickLength;
						tickGroup = "hourtick";
					} else {
						tickLength = minuteTickLength;
						tickClass = "minutetick";
					}
					svg.append("line")
					.attr("class", tickClass + " face")
					.attr("x1", cx)
					.attr("y1", margin)
					.attr("x2", cx)
					.attr("y2", margin + tickLength)
					.attr("transform", "rotate(" + i * 6 
						+ "," + cx + "," + cy + ")");
				}
			}

			function checkInput() {
				var smallRotate = rotate - 180;
				if (smallRotate % 30 == 0) {
					console.log('!');
					var e = smallRotate / 30;
					input = dataArray[e]['Sex Abuse '];
				}
			}

			function minuteHand() {
				svg.append("rect")
				.attr("width", 10)
				.attr("height", cy - 76)
				.attr("x", cx - 5)
				.attr("y", 66);
			}

			function hourHand() {
				svg.append("rect")
       .attr("id","myRect")
       .attr("fill","red")
       .attr("width",10).attr("height",150)
       .attr("x",-5)
       .attr("y",5)
       .attr("transform","translate("+w/2+","+h/2+")rotate("+rotate+")");
			}

			function secondHand(b) {
				svg.append("rect")
       .attr("id","myRect2")
       .attr("fill","blue")
       .attr("width",10).attr("height",b * 150)
       .attr("x",-5)
       .attr("y",5)
       .attr("transform","translate("+w/2+","+h/2+")rotate("+rotate+")");
			}

			svg.append("text")
			.attr("x", 20)
			.attr("y", 20)
			.attr("height", 10)
			.attr("width", 10)
			.attr("fill", "blue")
			.text(Math.round(parseFloat(input) * 100) + '%');

			svg.append("text")
			.attr("x", 50)
			.attr("y", 20)
			.attr("height", 10)
			.attr("width", 10)
			.attr("fill", "red")
			.text((100 - Math.round(parseFloat(input) * 100)) + '%');
		}

		showD3Clock();


	});
	</script>
</body>
</html>